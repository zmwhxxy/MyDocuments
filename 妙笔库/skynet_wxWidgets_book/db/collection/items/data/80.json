{"id":"01hd96yg9hnvr55gtdq59qnjx3","add_time_ms":1697895104817,"icon":"book","type":"doc","title":"添加自定义命令和生成文件","_id":"80","content":"## 添加自定义命令和生成文件\n假设对于本次教程而言,我们决定我们不再想使用平台的`log`和`exp`函数,并希望生成一些会在`mysqrt`函数里使用到的预计算值表.在本节,我们会建立这个表并作为构建的一步,然后编译到我们的应用中.\n\n首先,我们移除`MathFunctions/CMakeLists.txt`中的对`log`和`exp`的检查.然后移除`mysqrt.cxx`中对`HAVE_LOG`和`HAVR_EXP`的检查.同事,我们也可以移除`#include <cmath>`\n\n在`MathFunctions`子目录下,有一个新文件`MakeTable.cxx`用于生成表格.\n\n浏览这个文件可以发现,表格是C++代码生成的并且输出文件名是通过参数传入的.\n\n下一步是在`MathFunctions/CMakeLists.txt`中添加合适的命令来构建`MakeTable`可执行文件,然后作为构建流程的一部分来运行.需要一些命令来完成这一步.\n\n首先,在`MathFunctions/CMakeLists.txt`的开头,添加`MakeTable`为可执行文件目标.\n\n```CMake\nadd_executable(MakeTable MakeTable.cxx)\n```\n\n然后我们添加一项定义命令来指定怎么通过运行`MakeTable`创建表格.\n\n```Cmake\nadd_custom_command(\n  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/Table.h\n  COMMAND MakeTable ${CMAKE_CURRENT_BINARY_DIR}/Table.h\n  DEPENDS MakeTable\n  )\n```\n\n接下来我们要让CMake知道`mysqrt.cxx`依赖创建的`Table.h`.这是通过将生成`Table.h`添加到`MathFunctions`库的源列表.\n\n```CMake\nadd_library(MathFunctions\n            mysqrt.cxx\n            ${CMAKE_CURRENT_BINARY_DIR}/Table.h\n            )\n```\n\n现在让我们用上生成的表,首先,修改`mysqrt.cxx`来包含`Table.h`然后我们可以重写`mysqrt`函数以使用这张表:\n\n```C++\ndouble mysqrt(double x)\n{\n  if (x <= 0) {\n    return 0;\n  }\n\n  // use the table to help find an initial value\n  double result = x;\n  if (x >= 1 && x < 10) {\n    std::cout << \"Use the table to help find an initial value \" << std::endl;\n    result = sqrtTable[static_cast<int>(x)];\n  }\n\n  // do ten iterations\n  for (int i = 0; i < 10; ++i) {\n    if (result <= 0) {\n      result = 0.1;\n    }\n    double delta = x - (result * result);\n    result = result + 0.5 * delta / result;\n    std::cout << \"Computing sqrt of \" << x << \" to be \" << result << std::endl;\n  }\n\n  return result;\n}\n```\n\n运行`cmake`或者`cmake-gui`来配置项目并构建.\n\n当项目被构建时,首先被构建的是`MakeTable`,然后会运行`MakeTable`并创建`Table.h`.最后会编译包含了`Table.h`的`mysqrt.cxx`来创建MathFunctions库.\n\n运行Tutorial可执行文件然后验证使用了表格.","edit_time_ms":1697895142078,"char_count":{"word":590,"char_without_spaces":1508,"char_with_spaces":1709}}